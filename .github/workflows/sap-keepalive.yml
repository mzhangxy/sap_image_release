name: SAP CF Keepalive

on:
  schedule:
    # 北京时间 08:00 (UTC 00:00) 开始，每 10 分钟执行一次
    #- cron: '*/10 0 * * *'
  workflow_dispatch:

jobs:
  check-and-restart:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Cloud Foundry CLI
        run: |
          wget -q -O - https://packages.cloudfoundry.org/debian/cli.cloudfoundry.org.key | sudo apt-key add -
          echo "deb https://packages.cloudfoundry.org/debian stable main" | sudo tee /etc/apt/sources.list.d/cloudfoundry-cli.list
          sudo apt-get update
          sudo apt-get install cf8-cli

      - name: Login to SAP Cloud Foundry
        env:
          CF_API: ${{ secrets.CF_API }}
          CF_USERNAME: ${{ secrets.CF_USERNAME }}
          CF_PASSWORD: ${{ secrets.CF_PASSWORD }}
          CF_ORG: ${{ secrets.CF_ORG }}
          CF_SPACE: ${{ secrets.CF_SPACE }}
        run: |
          cf api "$CF_API"
          cf auth "$CF_USERNAME" "$CF_PASSWORD"
          cf target -o "$CF_ORG" -s "$CF_SPACE"

      - name: Check Status and Execute Logic
        env:
          CF_APP: ${{ secrets.CF_APP }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          # 定义发送 TG 消息的函数
          send_tg_message() {
            local message=$1
            curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TG_CHAT_ID}" \
              -d text="$message" > /dev/null
          }

          echo "Checking status for app: $CF_APP"
          
          # [修正点]：精确匹配 'requested state:' 并取第3列
          APP_STATE=$(cf app "$CF_APP" | grep "requested state:" | awk '{print $3}')
          echo "Current State: $APP_STATE"

          if [ "$APP_STATE" == "started" ]; then
            echo "App is RUNNING (started). Doing nothing."
            exit 0
          else
            echo "App is STOPPED. executing reset sequence..."
            send_tg_message "⚠️ SAP Keepalive: 检测到应用 $CF_APP 已停止，正在执行唤醒流程..."
            
            # 第一步：重启
            echo "Step 1: Restarting..."
            cf restart "$CF_APP"
            
            # 等待 15 秒确保状态更新
            sleep 15
            
            # 检查重启后的状态
            NEW_STATE=$(cf app "$CF_APP" | grep "requested state:" | awk '{print $3}')
            echo "State after Step 1: $NEW_STATE"
            
            if [ "$NEW_STATE" == "started" ]; then
                echo "Step 2: App is now RUNNING. "
                send_tg_message "✅ SAP Keepalive: 应用 $CF_APP 唤醒成功！"
                
            else
                echo "Error: Failed to bring app to started state."
                send_tg_message "❌ SAP Keepalive: 应用 $CF_APP 唤醒失败，请检查日志。"
                exit 1
            fi
          fi
